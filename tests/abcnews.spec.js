///////////////////////////////////////////////////////////////////////////////
// Unit tests for ABC News scripts, partially generated by Github Copilot.
//
// Copyright (c) 2026 Nicholas Paul Sheppard. See README.md for details
//
// Buy me a Ko-Fi at https://ko-fi.com/npsheppard.
///////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
// streamline.js tests
//
///////////////////////////////////////////////////////////////////////////////
describe('streamline.js', () => {

    let workingSpace;

    // before each test, create a skeleton of the page, containing only the components we want to test
    beforeEach(() => {
        // clear persistent values
        GM_clearValues();

        // create working space that will be reset at the end of each test
        workingSpace = document.createElement('div');
        document.body.appendChild(workingSpace);

        // element identified by id        
        const elementById = document.createElement('div');
        elementById.id = 'testElement';
        workingSpace.appendChild(elementById);

        // elements identified by class
        const elementsByClass = [
            document.createElement('div'),
            document.createElement('div')
        ];
        for (let e of elementsByClass) {
            e.className = 'testClass';
            workingSpace.appendChild(e);
        }

        // element identified by H2 heading test
        const headingContainer = mockRailElement('testHeadingContainer', 'abc123', 'Test Heading');
        workingSpace.appendChild(headingContainer);

        // mock rail element
        const railContainer = mockRailElement('railContainer', 'abc123');
        workingSpace.appendChild(railContainer);

    });


    afterEach(() => {
        // remove the working space
        document.body.removeChild(workingSpace);
    });


    it('applyRenderer', function() {
    
        // mock rendering function
        function mockRender(target) {
            if (target != null) {
                target.setAttribute('data-rendered', 'true');
            }
        };

        // get references to the test elements
        const elementById = document.getElementById('testElement');
        const elementsByClass = document.getElementsByClassName('testClass');
        const elementByHeading = workingSpace.querySelector('#testHeadingContainer .Rail_root__abc123');

        // invalid input should have no effect
        applyRenderer('', mockRender);
        applyRenderer('#', mockRender);
        applyRenderer('.', mockRender);
        expect(elementById.hasAttribute('data-rendered')).toBeFalse();
        expect(elementsByClass[0].hasAttribute('data-rendered')).toBeFalse();
        expect(elementsByClass[1].hasAttribute('data-rendered')).toBeFalse();
        expect(elementByHeading.hasAttribute('data-rendered')).toBeFalse();

        // element identified by id
        applyRenderer('#testElement', mockRender);
        expect(elementById.getAttribute('data-rendered')).toBe('true');
        expect(elementsByClass[0].hasAttribute('data-rendered')).toBeFalse();
        expect(elementsByClass[1].hasAttribute('data-rendered')).toBeFalse();
        expect(elementByHeading.hasAttribute('data-rendered')).toBeFalse();
        elementById.removeAttribute('data-rendered');
        
        // elements identified by class
        applyRenderer('.testClass', mockRender);
        for (let e of elementsByClass) {
            expect(e.getAttribute('data-rendered')).toBe('true');
            e.removeAttribute('data-rendered');
        }
        expect(elementById.hasAttribute('data-rendered')).toBeFalse();
        expect(elementByHeading.hasAttribute('data-rendered')).toBeFalse();

        // element identified by H2 heading text
        applyRenderer('Test Heading', mockRender);
        expect(elementByHeading.getAttribute('data-rendered')).toBe('true');
        expect(elementById.hasAttribute('data-rendered')).toBeFalse();
        expect(elementsByClass[0].hasAttribute('data-rendered')).toBeFalse();
        expect(elementsByClass[1].hasAttribute('data-rendered')).toBeFalse();

    });


    it('findRailRoot', () => {

        // check finding the root without any search
        const railRoot = workingSpace.querySelector('#railContainer > .Rail_root__abc123');
        const trivialRailRoot = findRailRoot(railRoot);
        expect(trivialRailRoot).toBe(railRoot);

        // check searching downwards
        const railContainer = document.getElementById('railContainer');
        const downwardsRailRoot = findRailRoot(railContainer);
        expect(downwardsRailRoot).toBe(railRoot);

        // check searching upwards
        const railChild = railRoot.firstElementChild;
        const upwardsRailRoot = findRailRoot(railChild);
        expect(upwardsRailRoot).toBe(railRoot);

        // return null when no rail root exists in the tree
        const testElement = document.getElementById('testElement');
        const nullRailRoot = findRailRoot(testElement);
        expect(nullRailRoot).toBeNull();

    });


    it('renderExpandable', () => {

        // get references to the test elements
        const root = workingSpace.querySelector('#railContainer > .Rail_root__abc123');
        const header = workingSpace.querySelector('#railContainer .Rail_header__abc123')
        const content = workingSpace.querySelector('#railContainer .Rail_content__abc123');

        // content is visible when startCompressed is not supplied
        renderExpandable(root);
        expect(content.style.display).not.toBe('none');

        // content is visible and cursor is zoom-out when startCompressed is false
        renderExpandable(root, false);
        expect(content.style.display).not.toBe('none');
        expect(header.style.cursor).toBe('zoom-out');

        // content is compressed and cursor is zoom-in when startCompressed is true
        renderExpandable(root, true);
        expect(content.style.display).toBe('none');
        expect(header.style.cursor).toBe('zoom-in');

        // clicking on a compressed header makes content visible and cursor zoom-out
        header.click();
        expect(content.style.display).toBe('block');
        expect(header.style.cursor).toBe('zoom-out');

        // clicking on expanded header hides content and makes the cursor zoom-in
        header.click();
        expect(content.style.display).toBe('none');
        expect(header.style.cursor).toBe('zoom-in');

        // mouseover sets header background to 'var(--nw-colour-theme-surface-tint)'; mouseout resets it
        const originalBackgroundColor = header.style.backgroundColor;
        header.dispatchEvent(new MouseEvent('mouseover', { bubbles: true }));
        expect(header.style.backgroundColor).toBe('var(--nw-colour-theme-surface-tint)');
        header.dispatchEvent(new MouseEvent('mouseout', { bubbles: true }));
        expect(header.style.backgroundColor).toBe(originalBackgroundColor);

        // handle malformed rail element gracefully
        const testElement = document.getElementById('testElement');
        expect(() => renderExpandable(testElement, false)).not.toThrow();

    });


    it('renderHidden', () => {

        // check single element
        const testElement = document.getElementById('testElement');
        testElement.style.display = 'block';
        renderHidden(testElement);
        expect(testElement.style.display).toBe('none');

        // check rail element
        const railContainer = document.getElementById('railContainer');
        const railRoot = workingSpace.querySelector('#railContainer > .Rail_root__abc123');
        const railChild = railRoot.firstElementChild;
        renderHidden(railRoot);
        expect(railRoot.style.display).toBe('none');
        expect(railContainer.style.display).not.toBe('none');
        expect(railChild.style.display).not.toBe('none');

    });

});


// Mock up a rail element. See streamline.renderExpandable() for the structure
// of a rail element.
//
// Input:
//   id (string) - an id for the containing div
//   nonce (string) - an arbitrary string to append to class names
//   title (string) - the text content of the header
//
// Returns: a div containing a rail element in the format used by the ABC site
function mockRailElement(id, nonce, title = null) {

    // containing div
    const container = document.createElement('div');
    container.id = id;

    // rail root
    const root = document.createElement('div');
    root.className = 'Rail_root__' + nonce + ' Rail_sideScrolling__' + nonce;
    container.appendChild(root);
    
    // rail header
    const header = document.createElement('div');
    header.className = 'Rail_header__' + nonce;
    root.appendChild(header);
    if (title != null) {
        const headerContent = document.createElement('h2');
        headerContent.textContent = title;
        header.append(headerContent);
    }

    // scrolling window
    const navigation = document.createElement('div');
    navigation.className = 'Rail_scollNavigation__' + nonce;
    root.appendChild(navigation);

    // content
    const content = document.createElement('div');
    content.className = 'Rail_content__' + nonce;
    root.appendChild(content);

    return container;

}
